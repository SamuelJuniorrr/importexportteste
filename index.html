<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prot√≥tipo do Portal Fluig - Import/Export</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px; /* Rounded corners for the main container */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 32px;
            max-width: 900px;
            width: 100%;
        }
        .header {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 20px;
            margin-bottom: 24px;
            text-align: center;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px; /* Rounded corners for inputs */
            font-size: 1rem;
            color: #374151;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px; /* Rounded corners for buttons */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .btn-primary {
            background-color: #3b82f6; /* Blue */
            color: #ffffff;
            border: none;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Darker blue on hover */
        }
        .btn-secondary {
            background-color: #f3f4f6; /* Light gray */
            color: #374151;
            border: 1px solid #d1d5db;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb; /* Darker light gray on hover */
        }
        .product-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            background-color: #f9fafb;
        }
        .message-box {
            background-color: #dbeafe; /* Light blue */
            border: 1px solid #93c5fd; /* Medium blue */
            color: #1e40af; /* Dark blue */
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        .error-message {
            background-color: #fee2e2; /* Light red */
            border: 1px solid #ef4444; /* Red */
            color: #b91c1c; /* Dark red */
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            font-weight: 500;
        }
        /* Style for live MOQ feedback */
        .moq-feedback-ok {
            color: #16a34a; /* Green */
            font-size: 0.875rem;
            margin-top: 4px;
        }
        .moq-feedback-error {
            color: #dc2626; /* Red */
            font-size: 0.875rem;
            margin-top: 4px;
        }
        /* Table styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .data-table th, .data-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: left;
        }
        .data-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Login Screen -->
        <div id="loginScreen" class="screen">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Bem-vindo ao Portal de Importa√ß√£o/Exporta√ß√£o</h1>
                <p class="text-gray-600">Fa√ßa login para continuar.</p>
            </div>
            <div class="space-y-4">
                <div class="form-group">
                    <label for="username">Usu√°rio:</label>
                    <input type="text" id="username" class="rounded-lg p-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seu nome de usu√°rio">
                </div>
                <div class="form-group">
                    <label for="password">Senha:</label>
                    <input type="password" id="password" class="rounded-lg p-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Sua senha">
                </div>
                <button onclick="login()" class="btn btn-primary w-full mt-6">Entrar</button>
            </div>
        </div>

        <!-- Filial Selection Screen -->
        <div id="filialSelectionScreen" class="screen hidden">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Escolha a Filial</h1>
                <p class="text-gray-600">Para qual filial voc√™ deseja enviar a solicita√ß√£o?</p>
            </div>
            <div class="flex flex-col md:flex-row gap-6 justify-center">
                <button onclick="selectFilial('colombia')" class="btn btn-primary md:w-1/2">Col√¥mbia</button>
                <button onclick="selectFilial('hongkong')" class="btn btn-primary md:w-1/2">Hong Kong</button>
            </div>
            <button onclick="logout()" class="btn btn-secondary w-full mt-6">Sair (Logout)</button>
        </div>

        <!-- Hong Kong Flow Screens -->
        <div id="hongKongFormScreen" class="screen hidden">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Solicita√ß√£o de Compra - Hong Kong</h1>
                <p class="text-gray-600">Por favor, preencha os detalhes dos produtos desejados.</p>
            </div>
            <div class="space-y-4">
                <div class="form-group">
                    <label for="productCode">C√≥digo do Produto:</label>
                    <input type="text" id="productCode" placeholder="Ex: SKU-123"
                        oninput="updateProductDetailsOnCodeChange()"
                        class="rounded-lg p-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="productDescription" class="text-gray-700 text-sm mt-2 font-medium"></div>
                </div>
                <div class="form-group">
                    <label for="productQuantity">Quantidade Solicitada:</label>
                    <input type="number" id="productQuantity" min="1" value="1"
                        oninput="checkMoqLive()"
                        class="rounded-lg p-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="moqLiveFeedback" class="text-xs mt-1"></div> <!-- Live feedback for MOQ -->
                </div>
                <button onclick="addProduct()" class="btn btn-secondary w-full">Adicionar Produto</button>
                <div id="productList" class="mt-4 border p-4 rounded-lg bg-gray-50 max-h-60 overflow-y-auto">
                    <h3 class="font-semibold text-gray-700 mb-2">Produtos Adicionados:</h3>
                    <div id="noProductsAdded" class="text-gray-500 text-center py-4">Nenhum produto adicionado ainda.</div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 mt-6">
                    <button onclick="backToFilialSelection()" class="btn btn-secondary flex-1">Voltar</button>
                    <button onclick="submitHongKongForm()" class="btn btn-primary flex-1">Enviar Solicita√ß√£o</button>
                </div>
            </div>
        </div>

        <div id="hongKongSummaryScreen" class="screen hidden">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Resumo da Solicita√ß√£o - Hong Kong</h1>
            </div>
            <div id="moqValidationResult"></div>
            <div id="supplierSplitResult" class="mt-4"></div>
            <div id="cubagemPricePrediction" class="mt-4"></div>
            <div class="mt-6 flex gap-4 justify-between" id="hkSummaryButtons">
                <button onclick="backToProductEntry()" class="btn btn-secondary flex-1">Voltar e Ajustar</button>
                <button onclick="generatePO()" class="btn btn-primary flex-1">Gerar Purchase Order</button>
            </div>
        </div>

        <div id="purchaseOrderScreen" class="screen hidden">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Purchase Order (PO) Gerada</h1>
                <p class="text-gray-600 mb-4">A PO foi gerada e enviada para Compras Internacionais.</p>
            </div>
            <div id="poDetails" class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <!-- PO details will be injected here -->
            </div>
            <div class="mt-6 text-center text-gray-600">
                <p>Aguardando negocia√ß√£o de Compras Internacionais e aprova√ß√£o do Renato.</p>
                <button onclick="simulateRenatoApprovalScreen()" class="btn btn-primary mt-4">Simular Aprova√ß√£o do Renato</button>
            </div>
        </div>

        <div id="renatoApprovalScreen" class="screen hidden">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Aprova√ß√£o do Renato</h1>
                <p class="text-gray-600 mb-4">Simula√ß√£o do processo de aprova√ß√£o do Renato.</p>
            </div>
            <div class="message-box">
                <!-- Comparison details will be injected here -->
            </div>
            <div class="mt-6 flex gap-4 justify-center">
                <button onclick="renatoApprove()" class="btn btn-primary flex-1 max-w-xs">Aprovar üëç</button>
                <button onclick="renatoReject()" class="btn btn-secondary flex-1 max-w-xs">N√£o Aprovar üëé</button>
            </div>
        </div>

        <div id="hongKongFinalScreen" class="screen hidden">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4" id="hongKongFinalTitle"></h1>
                <p class="text-gray-600" id="hongKongFinalMessage"></p>
            </div>
            <div class="message-box" id="finalDetailsHK">
                <!-- Final details based on approval/rejection -->
            </div>
            <button onclick="restartFlow()" class="btn btn-primary w-full mt-6">Iniciar Nova Solicita√ß√£o</button>
        </div>

        <!-- Colombia Flow Screens -->
        <div id="colombiaFormScreen" class="screen hidden">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Solicita√ß√£o de Compra - Col√¥mbia</h1>
                <p class="text-gray-600">Por favor, preencha os detalhes dos produtos desejados.</p>
            </div>
            <div class="space-y-4">
                <div class="form-group">
                    <label for="colombiaProductName">Nome do Produto:</label>
                    <input type="text" id="colombiaProductName" placeholder="Ex: Produto Col√¥mbia" class="rounded-lg p-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="form-group">
                    <label for="colombiaProductQuantity">Quantidade:</label>
                    <input type="number" id="colombiaProductQuantity" min="1" value="1" class="rounded-lg p-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="addColombiaProduct()" class="btn btn-secondary w-full">Adicionar Produto</button>
                <div id="colombiaProductList" class="mt-4 border p-4 rounded-lg bg-gray-50 max-h-60 overflow-y-auto">
                    <h3 class="font-semibold text-gray-700 mb-2">Produtos Adicionados:</h3>
                    <div id="noColombiaProductsAdded" class="text-gray-500 text-center py-4">Nenhum produto adicionado ainda.</div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 mt-6">
                    <button onclick="backToFilialSelection()" class="btn btn-secondary flex-1">Voltar</button>
                    <button onclick="submitColombiaForm()" class="btn btn-primary flex-1">Enviar Solicita√ß√£o para SAP</button>
                </div>
            </div>
        </div>

        <div id="colombiaInvoiceScreen" class="screen hidden">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Faturamento e Nota Fiscal - Col√¥mbia</h1>
                <p class="text-gray-600">Seu pedido foi faturado e a Nota Fiscal est√° dispon√≠vel.</p>
            </div>
            <div class="message-box">
                <p class="font-semibold">Nota Fiscal Eletr√¥nica (NF-e) gerada com sucesso!</p>
                <p>N√∫mero da NF-e: <span id="nfeNumber">NF-20250624-001</span></p>
                <p>Valor Total: <span id="nfeValue">R$ 1.500,00</span></p>
                <p class="mt-4">
                    <a href="#" onclick="showNfePdf()" class="text-blue-600 hover:underline">Visualizar PDF da NF-e</a>
                </p>
            </div>
            <div id="nfePdfViewer" class="hidden mt-6 bg-gray-100 p-4 rounded-lg border border-gray-200">
                <p class="text-gray-700">Simula√ß√£o de PDF da Nota Fiscal:</p>
                <pre class="bg-white p-4 rounded-md border border-gray-300 text-sm overflow-auto max-h-96 mt-2">
                    ----------------------------------------------------
                    |                NOTA FISCAL ELETR√îNICA            |
                    | N¬∫: NF-20250624-001                                |
                    | Data de Emiss√£o: 24/06/2025                        |
                    |                                                    |
                    | REMETENTE: EMPRESA XYZ DO BRASIL                   |
                    | CNPJ: 00.000.000/0001-00                           |
                    | ENDERE√áO: RUA EXEMPLO, 123 - S√ÉO PAULO/SP          |
                    |                                                    |
                    | DESTINAT√ÅRIO: CLIENTE INTERNACIONAL COL√îMBIA       |
                    | ENDERE√áO: CALLE 45, 7-30 - BOGOT√Å/COL√îMBIA         |
                    |                                                    |
                    | PRODUTOS:                                          |
                    | -------------------------------------------------- |
                    | ID | DESCRI√á√ÉO           | QTD | VALOR UNIT | TOTAL |
                    |----|---------------------|-----|------------|-------|
                    | 001| Produto Col√¥mbia A  | 10  | R$ 100,00  | R$ 1000,00 |
                    | 002| Produto Col√¥mbia B  | 5   | R$ 100,00  | R$ 500,00  |
                    |--------------------------------------------------|
                    | VALOR TOTAL:                                R$ 1.500,00 |
                    ----------------------------------------------------
                    (Este √© um exemplo simulado de NF-e.)
                </pre>
            </div>
            <button onclick="restartFlow()" class="btn btn-primary w-full mt-6">Iniciar Nova Solicita√ß√£o</button>
        </div>

        <!-- Generic Message Box (for alerts, confirmations) -->
        <div id="messageModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
                <h3 id="messageModalTitle" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <p id="messageModalContent" class="text-gray-700 mb-6"></p>
                <div class="flex justify-end gap-3">
                    <button id="messageModalConfirmBtn" class="btn btn-primary hidden">Confirmar</button>
                    <button id="messageModalCancelBtn" class="btn btn-secondary hidden">Cancelar</button>
                    <button id="messageModalCloseBtn" class="btn btn-primary">Ok</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- State Management ---
        let currentScreen = 'loginScreen';
        let selectedFilial = '';
        let hongKongProducts = [];
        let colombiaProducts = [];
        let simulatedPO = null; // Stores simulated PO details
        let renatoDecision = null; // 'approved' or 'rejected'

        // --- Constants for Container Capacities (in m¬≥) ---
        const MAX_CUBAGE_20HC = 37.4;
        const MAX_CUBAGE_40HC = 76.0;

        // --- Simulated Product Database (Code, Description, MOQ, Simulated Unit Price) ---
        const productDatabase = {
            "PROD001": { description: "Smartphone Premium X1", moq: 3, unitPrice: 150.00, cubageUnit: 0.005 },
            "PROD002": { description: "Tablet Pro Z", moq: 2, unitPrice: 250.00, cubageUnit: 0.008 },
            "PROD003": { description: "Fone Bluetooth Max", moq: 5, unitPrice: 45.00, cubageUnit: 0.001 },
            "PROD004": { description: "Smartwatch Sport Y", moq: 1, unitPrice: 80.00, cubageUnit: 0.002 },
            "PROD005": { description: "C√¢mera Digital Ultra HD", moq: 2, unitPrice: 300.00, cubageUnit: 0.01 },
            "PROD006": { description: "Bateria Port√°til Mega", moq: 10, unitPrice: 25.00, cubageUnit: 0.0005 }
        };

        // --- Utility Functions ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            currentScreen = screenId;
        }

        function showMessage(title, content, type = 'info', onConfirm = null, onCancel = null) {
            const modal = document.getElementById('messageModal');
            document.getElementById('messageModalTitle').innerText = title;
            document.getElementById('messageModalContent').innerText = content;

            const confirmBtn = document.getElementById('messageModalConfirmBtn');
            const cancelBtn = document.getElementById('messageModalCancelBtn');
            const closeBtn = document.getElementById('messageModalCloseBtn');

            confirmBtn.onclick = () => { if (onConfirm) onConfirm(); modal.classList.add('hidden'); };
            cancelBtn.onclick = () => { if (onCancel) onCancel(); modal.classList.add('hidden'); };
            closeBtn.onclick = () => modal.classList.add('hidden');

            confirmBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            closeBtn.classList.remove('hidden'); // Default close button

            if (onConfirm || onCancel) {
                closeBtn.classList.add('hidden'); // Hide default Ok if confirm/cancel present
                confirmBtn.classList.remove('hidden');
                if (onCancel) {
                    cancelBtn.classList.remove('hidden');
                }
            }
            modal.classList.remove('hidden');
        }

        // --- Flow Control ---
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username && password) {
                // Simple validation for prototype
                showScreen('filialSelectionScreen');
            } else {
                showMessage('Erro de Login', 'Por favor, preencha usu√°rio e senha.', 'error');
            }
        }

        function selectFilial(filial) {
            selectedFilial = filial;
            if (filial === 'colombia') {
                showScreen('colombiaFormScreen');
                renderColombiaProductList();
            } else if (filial === 'hongkong') {
                showScreen('hongKongFormScreen');
                renderHongKongProductList();
                // Clear live MOQ feedback and product description when entering the form
                document.getElementById('moqLiveFeedback').innerText = '';
                document.getElementById('productCode').value = '';
                document.getElementById('productDescription').innerText = '';
            }
        }

        // Function to go back to filial selection from forms
        function backToFilialSelection() {
            showScreen('filialSelectionScreen');
        }

        // Function for logout
        function logout() {
            // Reset all relevant state for a full logout
            selectedFilial = '';
            hongKongProducts = [];
            colombiaProducts = [];
            simulatedPO = null;
            renatoDecision = null;
            // Clear input fields for all forms
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('productCode').value = '';
            document.getElementById('productQuantity').value = '1';
            document.getElementById('colombiaProductName').value = '';
            document.getElementById('colombiaProductQuantity').value = '1';
            document.getElementById('productDescription').innerText = ''; // Clear description
            document.getElementById('moqLiveFeedback').innerText = ''; // Clear MOQ feedback

            showScreen('loginScreen');
        }

        function restartFlow() {
            // Reset all relevant state for a full restart
            selectedFilial = '';
            hongKongProducts = [];
            colombiaProducts = [];
            simulatedPO = null;
            renatoDecision = null;
            // Clear input fields for all forms
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('productCode').value = '';
            document.getElementById('productQuantity').value = '1';
            document.getElementById('colombiaProductName').value = '';
            document.getElementById('colombiaProductQuantity').value = '1';
            document.getElementById('productDescription').innerText = ''; // Clear description
            document.getElementById('moqLiveFeedback').innerText = ''; // Clear MOQ feedback

            showScreen('loginScreen');
        }

        // --- Hong Kong Flow Logic ---

        function updateProductDetailsOnCodeChange() {
            const productCode = document.getElementById('productCode').value.trim().toUpperCase();
            const productDescDiv = document.getElementById('productDescription');
            const moqLiveFeedbackDiv = document.getElementById('moqLiveFeedback');
            const productQuantityInput = document.getElementById('productQuantity');

            const productInfo = productDatabase[productCode];

            if (productInfo) {
                productDescDiv.innerText = `Descri√ß√£o: ${productInfo.description}`;
                productDescDiv.style.color = '#374151'; // Default text color
                // Also trigger MOQ check on quantity for the new product
                checkMoqLive();
            } else {
                productDescDiv.innerText = 'C√≥digo de produto n√£o encontrado.';
                productDescDiv.style.color = '#dc2626'; // Red for error
                moqLiveFeedbackDiv.innerText = ''; // Clear MOQ feedback
            }
        }

        function checkMoqLive() {
            const productCode = document.getElementById('productCode').value.trim().toUpperCase();
            const productQuantity = parseInt(document.getElementById('productQuantity').value);
            const moqFeedbackDiv = document.getElementById('moqLiveFeedback');

            const productInfo = productDatabase[productCode];

            if (!productInfo) {
                moqFeedbackDiv.innerText = 'Por favor, insira um c√≥digo de produto v√°lido.';
                moqFeedbackDiv.className = 'moq-feedback-error';
                return;
            }

            if (isNaN(productQuantity) || productQuantity <= 0) {
                moqFeedbackDiv.innerText = '';
                moqFeedbackDiv.className = 'text-xs mt-1';
                return;
            }

            const moq = productInfo.moq;

            if (productQuantity < moq) {
                moqFeedbackDiv.innerText = `‚ö†Ô∏è Quantidade (${productQuantity}) abaixo do MOQ m√≠nimo (${moq}). Este item ser√° cancelado se n√£o for ajustado.`;
                moqFeedbackDiv.className = 'moq-feedback-error';
            } else {
                moqFeedbackDiv.innerText = `‚úÖ Quantidade (${productQuantity}) atende ao MOQ m√≠nimo (${moq}).`;
                moqFeedbackDiv.className = 'moq-feedback-ok';
            }
        }

        function addProduct() {
            const code = document.getElementById('productCode').value.trim().toUpperCase();
            const quantity = parseInt(document.getElementById('productQuantity').value);
            const productInfo = productDatabase[code];

            if (!productInfo) {
                showMessage('Erro', 'C√≥digo de produto inv√°lido. Por favor, selecione um produto v√°lido.', 'error');
                return;
            }

            if (isNaN(quantity) || quantity <= 0) {
                showMessage('Erro', 'Por favor, insira uma quantidade v√°lida para o produto.', 'error');
                return;
            }

            // Check MOQ before adding to list
            if (quantity < productInfo.moq) {
                showMessage('Alerta de MOQ', `A quantidade (${quantity}) do produto "${productInfo.description}" est√° abaixo do MOQ m√≠nimo de ${productInfo.moq}. Este item ser√° cancelado do pedido ao enviar, a menos que voc√™ aumente a quantidade.`, 'warning');
                // Still allow adding to list for demo, but flag it
            }


            // Check if product already in list, if so, update quantity
            const existingProductIndex = hongKongProducts.findIndex(p => p.code === code);
            if (existingProductIndex > -1) {
                hongKongProducts[existingProductIndex].quantity += quantity;
            } else {
                hongKongProducts.push({
                    code: code,
                    name: productInfo.description,
                    quantity: quantity,
                    moq: productInfo.moq,
                    unitPrice: productInfo.unitPrice,
                    cubageUnit: productInfo.cubageUnit
                });
            }

            renderHongKongProductList();
            document.getElementById('productCode').value = '';
            document.getElementById('productDescription').innerText = '';
            document.getElementById('productQuantity').value = '1'; // Reset quantity
            document.getElementById('moqLiveFeedback').innerText = ''; // Clear live feedback
        }

        function removeProduct(index) {
            hongKongProducts.splice(index, 1);
            renderHongKongProductList();
        }

        function renderHongKongProductList() {
            const listDiv = document.getElementById('productList');
            listDiv.innerHTML = '<h3 class="font-semibold text-gray-700 mb-2">Produtos Adicionados:</h3>';
            if (hongKongProducts.length === 0) {
                listDiv.innerHTML += '<div id="noProductsAdded" class="text-gray-500 text-center py-4">Nenhum produto adicionado ainda.</div>';
                return;
            }

            // Create a table for the added products
            let tableHtml = `<table class="data-table">
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Descri√ß√£o Produto</th>
                                        <th>Quantidade Solicitada</th>
                                        <th>A√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            hongKongProducts.forEach((product, index) => {
                tableHtml += `
                    <tr>
                        <td>${product.code}</td>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td><button onclick="removeProduct(${index})" class="text-red-500 hover:text-red-700 font-bold text-sm">Remover</button></td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            listDiv.innerHTML = listDiv.innerHTML.split('<div id="noProductsAdded"')[0] + tableHtml; // Keep heading, replace if no products msg
        }

        function submitHongKongForm() {
            if (hongKongProducts.length === 0) {
                showMessage('Erro', 'Por favor, adicione pelo menos um produto antes de enviar a solicita√ß√£o.', 'error');
                return;
            }

            let moqValidationResultDiv = document.getElementById('moqValidationResult');
            moqValidationResultDiv.innerHTML = '<h3 class="font-semibold text-gray-700 mb-2">Valida√ß√£o de MOQ:</h3>';

            let validProductsAfterMoq = [];
            let allItemsCancelled = true; // Assume all items will be cancelled initially

            hongKongProducts.forEach(product => {
                if (product.quantity < product.moq) { // Use product.moq from the stored product info
                    moqValidationResultDiv.innerHTML += `<p class="error-message">üö´ O item "${product.name}" (Qtd: ${product.quantity}) n√£o atende ao MOQ m√≠nimo de ${product.moq}. Este item ser√° cancelado do pedido.</p>`;
                } else {
                    moqValidationResultDiv.innerHTML += `<p class="text-green-700">‚úÖ O item "${product.name}" (Qtd: ${product.quantity}) atende ao MOQ m√≠nimo de ${product.moq}.</p>`;
                    validProductsAfterMoq.push(product);
                    allItemsCancelled = false; // If at least one item is valid, set to false
                }
            });

            hongKongProducts = validProductsAfterMoq; // Update global list with only valid products

            const hkSummaryButtonsDiv = document.getElementById('hkSummaryButtons');
            const generatePoButton = hkSummaryButtonsDiv.querySelector('button:last-child'); // The 'Gerar Purchase Order' button

            if (hongKongProducts.length === 0) { // Check length after MOQ validation to see if any valid products remain
                moqValidationResultDiv.innerHTML += `<p class="error-message mt-4">Todos os itens foram cancelados devido √† falha no MOQ. Por favor, utilize o bot√£o "Voltar e Ajustar" para corrigir sua solicita√ß√£o.</p>`;
                generatePoButton.classList.add('hidden'); // Hide PO button
            } else {
                generatePoButton.classList.remove('hidden'); // Ensure PO button is visible if there are valid products

                // Simulate supplier split and create table
                let supplierSplitHTML = '<h3 class="font-semibold text-gray-700 mt-4 mb-2">Divis√£o por Fornecedor:</h3>';
                const suppliers = ['Fornecedor A', 'Fornecedor B', 'Fornecedor C'];
                const supplierOrders = {};

                if (hongKongProducts.length === 1) {
                    supplierSplitHTML += `<div class="mb-4 p-2 border rounded-md bg-white">
                                            <strong>Pedido √önico:</strong>
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>C√≥digo</th>
                                                        <th>Descri√ß√£o Produto</th>
                                                        <th>Quantidade Solicitada</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>${hongKongProducts[0].code}</td>
                                                        <td>${hongKongProducts[0].name}</td>
                                                        <td>${hongKongProducts[0].quantity}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                          </div>`;
                } else {
                    hongKongProducts.forEach(product => {
                        // Assign a random supplier for the prototype
                        const randomSupplier = suppliers[Math.floor(Math.random() * suppliers.length)];
                        if (!supplierOrders[randomSupplier]) {
                            supplierOrders[randomSupplier] = [];
                        }
                        supplierOrders[randomSupplier].push(product);
                    });

                    for (const supplier in supplierOrders) {
                        supplierSplitHTML += `<div class="mb-4 p-2 border rounded-md bg-white">
                                                <strong>${supplier}:</strong>
                                                <table class="data-table">
                                                    <thead>
                                                        <tr>
                                                            <th>C√≥digo</th>
                                                            <th>Descri√ß√£o Produto</th>
                                                            <th>Quantidade Solicitada</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>`;
                        supplierOrders[supplier].forEach(item => {
                            supplierSplitHTML += `
                                                        <tr>
                                                            <td>${item.code}</td>
                                                            <td>${item.name}</td>
                                                            <td>${item.quantity}</td>
                                                        </tr>`;
                        });
                        supplierSplitHTML += `
                                                    </tbody>
                                                </table>
                                              </div>`;
                    }
                }
                document.getElementById('supplierSplitResult').innerHTML = supplierSplitHTML;

                // Simulate cubagem and acquisition price prediction
                let totalCubagem = 0;
                let estimatedAcquisitionValue = 0; // Renamed for clarity as per user request

                hongKongProducts.forEach(p => {
                    totalCubagem += p.cubageUnit * p.quantity;
                    estimatedAcquisitionValue += p.unitPrice * p.quantity;

                    // Store per-product prices for Renato's approval screen
                    // Generate currentInternalUnitPrice here for new comparison
                    p.newSupplierUnitPrice = p.unitPrice.toFixed(2);
                    p.currentInternalUnitPrice = (p.unitPrice * (1 + (Math.random() * 0.1 + 0.05))).toFixed(2); // 5-15% higher
                });

                // Calculate percentage of container occupied
                const percent20HC = ((totalCubagem / MAX_CUBAGE_20HC) * 100).toFixed(2);
                const percent40HC = ((totalCubagem / MAX_CUBAGE_40HC) * 100).toFixed(2);

                document.getElementById('cubagemPricePrediction').innerHTML = `
                    <h3 class="font-semibold text-gray-700 mt-4 mb-2">Previs√£o de Cubagem e Pre√ßos de Aquisi√ß√£o:</h3>
                    <p>Cubagem Total Estimada: ${totalCubagem.toFixed(2).replace('.', ',')} m¬≥</p>
                    <ul class="list-disc pl-5">
                        <li>Percentual Container 20 HC: ${percent20HC}% (Capacidade: ${MAX_CUBAGE_20HC} m¬≥)</li>
                        <li>Percentual Container 40 HC: ${percent40HC}% (Capacidade: ${MAX_CUBAGE_40HC} m¬≥)</li>
                    </ul>
                    <p class="font-semibold mt-4">Valor de Aquisi√ß√£o Total Estimado dos Produtos: R$ ${estimatedAcquisitionValue.toFixed(2).replace('.', ',')}</p>
                    <p class="text-sm text-gray-500 mt-2">Os pre√ßos s√£o baseados em tabelas de refer√™ncia e podem variar. A cubagem √© um percentual da capacidade do container.</p>
                `;
            }
            showScreen('hongKongSummaryScreen');
        }

        function backToProductEntry() {
            showScreen('hongKongFormScreen');
            renderHongKongProductList(); // Re-render list if user comes back
            document.getElementById('moqLiveFeedback').innerText = ''; // Clear live feedback
            document.getElementById('productCode').value = ''; // Clear product code
            document.getElementById('productDescription').innerText = ''; // Clear description
            document.getElementById('productQuantity').value = '1'; // Reset quantity
        }

        function generatePO() {
            // Get the estimated acquisition value from the summary screen
            const estimatedAcquisitionValueText = document.getElementById('cubagemPricePrediction').innerText.match(/Valor de Aquisi√ß√£o Total Estimado dos Produtos: R\$ ([\d\.,]+)/)?.[1];
            const newSupplierPriceTotal = parseFloat(estimatedAcquisitionValueText.replace('.', '').replace(',', '.')).toFixed(2);

            // Calculate total current internal price from individual product prices
            let currentInternalPriceTotal = 0;
            hongKongProducts.forEach(p => {
                currentInternalPriceTotal += parseFloat(p.currentInternalUnitPrice) * p.quantity; // Summing total current internal price per quantity
            });
            currentInternalPriceTotal = currentInternalPriceTotal.toFixed(2);


            simulatedPO = {
                id: `PO-${Math.floor(Math.random() * 10000)}`,
                date: new Date().toLocaleDateString('pt-BR'),
                products: hongKongProducts, // This now contains per-product unit prices
                newSupplierPriceTotal: newSupplierPriceTotal, // Total 'new' price
                currentInternalPriceTotal: currentInternalPriceTotal // Total 'current' price
            };

            document.getElementById('poDetails').innerHTML = `
                <p class="font-semibold text-lg mb-2">Detalhes da Purchase Order:</p>
                <p><strong>ID da PO:</strong> ${simulatedPO.id}</p>
                <p><strong>Data de Emiss√£o:</strong> ${simulatedPO.date}</p>
                <p class="mt-4 font-semibold">Produtos na PO:</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Descri√ß√£o</th>
                            <th>Quantidade</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${simulatedPO.products.map(p => `
                            <tr>
                                <td>${p.code}</td>
                                <td>${p.name}</td>
                                <td>${p.quantity}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p class="mt-4 font-semibold text-xl">Valor Total Estimado (Proposta Fornecedor): R$ ${simulatedPO.newSupplierPriceTotal.replace('.', ',')}</p>
            `;
            showScreen('purchaseOrderScreen');
        }

        function simulateRenatoApprovalScreen() {
            if (!simulatedPO) {
                showMessage('Erro', 'Nenhuma PO gerada para simular a aprova√ß√£o do Renato.', 'error');
                return;
            }

            const renatoMessageBox = document.querySelector('#renatoApprovalScreen .message-box');
            let comparisonTableHTML = `
                <p class="font-semibold text-lg mb-4">An√°lise Comparativa de Pre√ßos por Produto</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Produto (C√≥digo)</th>
                            <th>Pre√ßo Interno (Atual)</th>
                            <th>Pre√ßo Fornecedor (Novo)</th>
                            <th>Diferen√ßa Unit√°ria</th>
                            <th>Diferen√ßa Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let overallPriceDifferenceTotal = 0;

            simulatedPO.products.forEach(p => {
                const currentPrice = parseFloat(p.currentInternalUnitPrice);
                const newPrice = parseFloat(p.newSupplierUnitPrice);
                const differenceUnit = (newPrice - currentPrice).toFixed(2);
                const differenceTotalPerProduct = (differenceUnit * p.quantity).toFixed(2);
                overallPriceDifferenceTotal += parseFloat(differenceTotalPerProduct);

                const newPriceClass = newPrice > currentPrice ? 'text-red-600 font-bold' : 'text-green-600 font-bold';

                comparisonTableHTML += `
                    <tr>
                        <td>${p.name} (${p.code})</td>
                        <td>R$ ${currentPrice.toFixed(2).replace('.', ',')}</td>
                        <td class="${newPriceClass}">R$ ${newPrice.toFixed(2).replace('.', ',')}</td>
                        <td>R$ ${differenceUnit.replace('.', ',')}</td>
                        <td>R$ ${differenceTotalPerProduct.replace('.', ',')}</td>
                    </tr>
                `;
            });

            comparisonTableHTML += `
                    </tbody>
                </table>
                <p class="mt-6">Prezado Renato,</p>
                <p>Estamos apresentando a proposta para a Purchase Order **${simulatedPO.id}**.</p>
                <p class="mt-4"><strong>Valor Total Interno (Atual):</strong> <span class="text-blue-700 font-bold">R$ ${simulatedPO.currentInternalPriceTotal.replace('.', ',')}</span></p>
                <p><strong>Valor Total Fornecedor (Novo):</strong> <span class="text-green-700 font-bold">R$ ${simulatedPO.newSupplierPriceTotal.replace('.', ',')}</span></p>
                <p class="mt-4">**Diferen√ßa Total Geral:** <span class="${overallPriceDifferenceTotal > 0 ? 'text-red-600' : 'text-green-600'} font-bold">R$ ${overallPriceDifferenceTotal.toFixed(2).replace('.', ',')}</span></p>
                <p class="mt-4">Sua aprova√ß√£o √© crucial para darmos continuidade ao processo.</p>
            `;

            renatoMessageBox.innerHTML = comparisonTableHTML;
            showScreen('renatoApprovalScreen');
        }

        function renatoApprove() {
            renatoDecision = 'approved';
            document.getElementById('hongKongFinalTitle').innerText = 'Parab√©ns! Pedido Aprovado!';
            document.getElementById('hongKongFinalMessage').innerText = 'Renato aprovou sua solicita√ß√£o. Compras Internacionais enviar√° a confirma√ß√£o ao fornecedor e atualizar√° os pre√ßos finais no portal.';
            document.getElementById('finalDetailsHK').innerHTML = `
                <p class="font-semibold">Status: APROVADO ‚úÖ</p>
                <p>Seu pedido ${simulatedPO.id} foi aprovado.</p>
                <p class="mt-2">O valor de aquisi√ß√£o final negociado √© de: <span class="font-bold">R$ ${simulatedPO.newSupplierPriceTotal.replace('.', ',')}</span></p>
                <p class="mt-2">Em breve, voc√™ receber√° a atualiza√ß√£o com os pre√ßos e quantidades finais fechadas.</p>
            `;
            showScreen('hongKongFinalScreen');
        }

        function renatoReject() {
            renatoDecision = 'rejected';
            document.getElementById('hongKongFinalTitle').innerText = 'Solicita√ß√£o Rejeitada!';
            document.getElementById('hongKongFinalMessage').innerText = 'Renato n√£o aprovou a proposta atual. A equipe de Compras Internacionais ir√° renegociar com o fornecedor.';
            document.getElementById('finalDetailsHK').innerHTML = `
                <p class="font-semibold">Status: REJEITADO ‚ùå</p>
                <p>O pedido ${simulatedPO.id} n√£o foi aprovado na negocia√ß√£o atual.</p>
                <p class="mt-2">A equipe de Compras Internacionais ser√° notificada para renegociar com o fornecedor.</p>
            `;
            // Redirect back to PO screen for simulation of renegotiation
            setTimeout(() => {
                showScreen('purchaseOrderScreen');
            }, 2000); // Give user a moment to read the message
        }

        // --- Colombia Flow Logic ---
        function addColombiaProduct() {
            const name = document.getElementById('colombiaProductName').value.trim();
            const quantity = parseInt(document.getElementById('colombiaProductQuantity').value);

            if (name && quantity > 0) {
                colombiaProducts.push({ name, quantity });
                renderColombiaProductList();
                document.getElementById('colombiaProductName').value = '';
                document.getElementById('colombiaProductQuantity').value = '1';
            } else {
                showMessage('Erro', 'Por favor, insira um nome e uma quantidade v√°lida para o produto.', 'error');
            }
        }

        function removeColombiaProduct(index) {
            colombiaProducts.splice(index, 1);
            renderColombiaProductList();
        }

        function renderColombiaProductList() {
            const listDiv = document.getElementById('colombiaProductList');
            listDiv.innerHTML = '<h3 class="font-semibold text-gray-700 mb-2">Produtos Adicionados:</h3>';
            if (colombiaProducts.length === 0) {
                listDiv.innerHTML += '<div id="noColombiaProductsAdded" class="text-gray-500 text-center py-4">Nenhum produto adicionado ainda.</div>';
                return;
            }

            colombiaProducts.forEach((product, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'product-item';
                itemDiv.innerHTML = `
                    <span class="flex-1 text-gray-800">${product.name} (Qtd: ${product.quantity})</span>
                    <button onclick="removeColombiaProduct(${index})" class="text-red-500 hover:text-red-700 font-bold">X</button>
                `;
                listDiv.appendChild(itemDiv);
            });
        }

        function submitColombiaForm() {
            if (colombiaProducts.length === 0) {
                showMessage('Erro', 'Por favor, adicione pelo menos um produto antes de enviar a solicita√ß√£o.', 'error');
                return;
            }
            // Simulate sending to SAP and receiving invoice
            setTimeout(() => {
                // Generate a simulated total value for NF-e based on Colombia products
                const totalNfeValue = colombiaProducts.reduce((sum, p) => sum + (p.quantity * (Math.random() * 50 + 5)), 0).toFixed(2);
                document.getElementById('nfeValue').innerText = `R$ ${totalNfeValue.replace('.', ',')}`;

                // Update NF-e PDF content with actual products
                let productsInNfePdf = colombiaProducts.map((p, idx) => `| ${String(idx + 1).padStart(2, '0')}| ${p.name.padEnd(17)}| ${String(p.quantity).padEnd(3)} | R$ ${(p.quantity * (Math.random() * 10 + 5)).toFixed(2).padEnd(10)}| R$ ${(p.quantity * (Math.random() * 10 + 5)).toFixed(2).padEnd(6)} |`).join('\n');
                let nfePdfContent = `
                    ----------------------------------------------------
                    |                NOTA FISCAL ELETR√îNICA            |
                    | N¬∫: NF-20250624-001                                |
                    | Data de Emiss√£o: 24/06/2025                        |
                    |                                                    |
                    | REMETENTE: EMPRESA XYZ DO BRASIL                   |
                    | CNPJ: 00.000.000/0001-00                           |
                    | ENDERE√áO: RUA EXEMPLO, 123 - S√ÉO PAULO/SP          |
                    |                                                    |
                    | DESTINAT√ÅRIO: CLIENTE INTERNACIONAL COL√îMBIA       |
                    | ENDERE√áO: CALLE 45, 7-30 - BOGOT√Å/COL√îMBIA         |
                    |                                                    |
                    | PRODUTOS:                                          |
                    | -------------------------------------------------- |
                    | ID | DESCRI√á√ÉO           | QTD | VALOR UNIT | TOTAL |
                    |----|---------------------|-----|------------|-------|
                    ${productsInNfePdf}
                    |--------------------------------------------------|
                    | VALOR TOTAL:                                R$ ${totalNfeValue.replace('.', ',')} |
                    ----------------------------------------------------
                    (Este √© um exemplo simulado de NF-e.)
                `;
                document.querySelector('#nfePdfViewer pre').innerText = nfePdfContent;

                showScreen('colombiaInvoiceScreen');
            }, 1500); // Simulate network delay
        }

        function showNfePdf() {
            const pdfViewer = document.getElementById('nfePdfViewer');
            pdfViewer.classList.toggle('hidden');
        }

        // --- Initial Screen Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('loginScreen');
        });
    </script>
</body>
</html>
