<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Fluig - Aprova√ß√£o Gerencial</title>
    <!-- Link para o arquivo CSS externo -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- Aprova√ß√£o de Pre√ßos - Gerencial -->
    <div id="renatoApprovalScreen" class="page active">
        <header class="header">
            <div class="header-left">
                <h1>Aprova√ß√£o de Pre√ßos - Gerencial</h1>
            </div>
            <div class="header-right">
                <span class="header-icon" onclick="showScreenInfo()"><i class="icon-question"></i></span>
                <span class="header-icon" onclick="openFlowchartModal()"><i class="icon-flow"></i></span> <!-- Bot√£o Fluxo -->
                <button class="btn-secondary" id="renatoLogoutButton">Sair (Logout)</button>
            </div>
        </header>

        <div class="container">
            <div class="filters">
                <div class="filter-group">
                    <label for="renatoPoSupplierFilter">Fornecedor:</label>
                    <select id="renatoPoSupplierFilter" onchange="renderRenatoApprovalTables()">
                        <option value="Todos">Todos</option>
                        <!-- Op√ß√µes de fornecedor ser√£o populadas via JS -->
                    </select>
                </div>
                <div class="filter-group">
                    <label for="renatoPoOriginCountryFilter">Pa√≠s Origem:</label>
                    <select id="renatoPoOriginCountryFilter" onchange="renderRenatoApprovalTables()">
                        <option value="Todos">Todos</option>
                        <!-- Op√ß√µes de pa√≠s de origem ser√£o populadas via JS -->
                    </select>
                </div>
                <div class="filter-group search-group">
                    <label for="renatoPoSearch">Buscar por N¬∫ PO ou ID Solicita√ß√£o:</label>
                    <div class="search-input-wrapper">
                        <input type="text" id="renatoPoSearch" placeholder="Buscar por N¬∫ PO ou ID Solicita√ß√£o">
                        <button class="search-icon-btn" onclick="renderRenatoApprovalTables()"><i class="icon-search"></i></button>
                    </div>
                </div>
            </div>

            <div class="tab-buttons" id="renatoApprovalTabButtons">
                <button class="tab-button active" onclick="switchRenatoApprovalTab('pendingApproval')">Aguardando Aprova√ß√£o</button>
                <button class="tab-button" onclick="switchRenatoApprovalTab('approvedRejected')">Aprovados/Rejeitados</button>
            </div>

            <div id="pendingApprovalTab" class="tab-content active">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID SOLICITA√á√ÉO PRINCIPAL</th>
                                <th>N¬∫ PO</th>
                                <th>FORNECEDOR (C√ìDIGO)</th>
                                <th>PA√çS ORIGEM</th>
                                <th>VALOR TOTAL (FORNECEDOR)</th>
                                <th>STATUS DA PO</th>
                                <th>DATA GERA√á√ÉO</th>
                                <th>A√á√ÉO</th>
                            </tr>
                        </thead>
                        <tbody id="renatoPendingApprovalTableBody">
                            <!-- Pending Approval POs will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="approvedRejectedTab" class="tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID SOLICITA√á√ÉO PRINCIPAL</th>
                                <th>N¬∫ PO</th>
                                <th>FORNECEDOR (C√ìDIGO)</th>
                                <th>PA√çS ORIGEM</th>
                                <th>VALOR TOTAL (FORNECEDOR)</th>
                                <th>STATUS DA PO</th>
                                <th>DATA GERA√á√ÉO</th>
                                <th>STATUS FINAL</th>
                            </tr>
                        </thead>
                        <tbody id="renatoApprovedRejectedTableBody">
                            <!-- Approved/Rejected POs will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Detalhes da PO para Aprova√ß√£o -->
    <div id="renatoPoDetailsScreen" class="page">
        <header class="header">
            <div class="header-left">
                <h1>Detalhes da PO para Aprova√ß√£o <span id="renatoCurrentPoId"></span></h1>
            </div>
            <div class="header-right">
                <span class="header-icon" onclick="showScreenInfo()"><i class="icon-question"></i></span>
                <span class="header-icon" onclick="openFlowchartModal()"><i class="icon-flow"></i></span> <!-- Bot√£o Fluxo -->
            </div>
        </header>
        <div class="container">
            <div class="form-section">
                <h2 class="text-xl font-semibold mb-4">Informa√ß√µes Gerais da PO</h2>
                <div class="details-grid">
                    <div class="detail-row">
                        <div class="detail-label">N¬∫ PO:</div>
                        <div class="detail-value" id="renatoPoDetailId"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ID Solicita√ß√£o Principal:</div>
                        <div class="detail-value" id="renatoPoDetailParentOrderId"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Fornecedor:</div>
                        <div class="detail-value" id="renatoPoDetailSupplier"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Pa√≠s de Origem:</div>
                        <div class="detail-value" id="renatoPoDetailOriginCountry"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Valor Total (Fornecedor):</div>
                        <div class="detail-value" id="renatoPoDetailNewSupplierPriceTotal"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Valor Total (Interno):</div>
                        <div class="detail-value" id="renatoPoDetailCurrentInternalPriceTotal"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Status Geral da PO:</div>
                        <div class="detail-value" id="renatoPoDetailOverallApprovalStatus"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Data de Gera√ß√£o:</div>
                        <div class="detail-value" id="renatoPoDetailDate"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Notas de Negocia√ß√£o:</div>
                        <div class="detail-value" id="renatoPoDetailNegotiationNotes"></div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="text-xl font-semibold mb-4">Produtos na PO para Aprova√ß√£o</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>C√≥d Produto</th>
                                <th>Descri√ß√£o</th>
                                <th>Qtd.</th>
                                <th>Valor Unit. Interno</th>
                                <th>Valor Unit. Fornecedor (Atual)</th>
                                <th>Dif.</th>
                                <th>Valor Total Interno</th>
                                <th>Valor Total Fornecedor</th>
                                <th>Status Aprova√ß√£o</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="renatoPoDetailsProductsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn-secondary" onclick="backToRenatoApprovalCenter()">Voltar para Central de Aprova√ß√£o</button>
                <button class="btn-primary" onclick="finalizePOApproval(currentViewingPO.id)">Finalizar Aprova√ß√£o da PO</button>
            </div>
        </div>
    </div>

    <!-- Modais Globais -->
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="messageModalCloseBtn">&times;</button>
            <h3 id="messageModalTitle"></h3>
            <div id="messageModalContent"></div>
            <div class="modal-actions">
                <button class="btn-primary" id="messageModalConfirmBtn">OK</button>
                <button class="btn-secondary" id="messageModalCancelBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Flowchart Modal Structure -->
    <div id="flowchartModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeFlowchartModal()">&times;</span>
            <img id="flowchartImage" src="https://raw.githubusercontent.com/SamuelJuniorrr/importexport/refs/heads/main/fluxograma.png" alt="Fluxograma do Processo">
        </div>
    </div>

    <!-- Link para o arquivo JavaScript externo -->
    <script src="script.js"></script>
    <script>
        /**
         * Exibe informa√ß√µes sobre a tela atual para o usu√°rio Gestor.
         */
        function showScreenInfo() {
            let info = '';
            switch (currentScreen) {
                case 'renatoApprovalScreen':
                    info = `
                        <h2 style="font-size:1.3rem; font-weight:bold; margin-bottom:10px;">‚úÖ Aprova√ß√£o de Pre√ßos - Gerencial</h2>
                        <p>Bem-vindo √† <b>Central de Aprova√ß√£o</b>! Aqui voc√™ revisa e aprova as Ordens de Compra (POs) negociadas pelo time de Compras Internacionais.</p>
                        <hr style="margin:16px 0;">
                        <h3 style="font-size:1.1rem; font-weight:bold;">üîç Busca e Filtros</h3>
                        <ul style="margin-bottom:10px;">
                        <li>Filtre POs por <b>Fornecedor</b> (c√≥digo) ou <b>Pa√≠s de Origem</b>.</li>
                        <li>Utilize a busca r√°pida por n√∫mero da PO ou ID da Solicita√ß√£o Principal.</li>
                        </ul>
                        <h3 style="font-size:1.1rem; font-weight:bold;">üìã Visualiza√ß√£o das POs</h3>
                        <ul style="margin-bottom:10px;">
                        <li><b>Aguardando Aprova√ß√£o:</b> POs prontas para sua revis√£o.</li>
                        <li><b>Aprovados/Rejeitados:</b> Hist√≥rico de POs j√° processadas.</li>
                        <li>Clique em <b>Ver Detalhes</b> para analisar cada produto e tomar sua decis√£o.</li>
                        </ul>
                        <h3 style="font-size:1.1rem; font-weight:bold;">üìä Decis√£o de Aprova√ß√£o</h3>
                        <ul style="margin-bottom:10px;">
                        <li>Para cada item, voc√™ pode <b>Aprovar</b>, <b>Negociar</b> (o que requer nova negocia√ß√£o pelo time de Compras) ou <b>Rejeitar</b>.</li>
                        <li>Uma PO s√≥ pode ser <b>Finalizada</b> quando todos os seus itens tiverem um status de aprova√ß√£o.</li>
                        </ul>
                        <hr style="margin:16px 0;">
                        <p style="font-size:0.95rem;">Se precisar de ajuda, clique novamente neste √≠cone ou consulte o manual do usu√°rio.</p>
                    `;
                    break;
                case 'renatoPoDetailsScreen':
                    info = `
                        <h2 style="font-size:1.3rem; font-weight:bold; margin-bottom:10px;">üìÑ Detalhes da PO para Aprova√ß√£o</h2>
                        <p>Analise os detalhes da Ordem de Compra (PO) e decida sobre cada item.</p>
                        <hr style="margin:16px 0;">
                        <ul style="margin-bottom:10px;">
                        <li><b>Informa√ß√µes Gerais:</b> Dados b√°sicos da PO, valores internos e do fornecedor, e notas de negocia√ß√£o.</li>
                        <li><b>Produtos na PO:</b> Lista de itens com suas quantidades, valores unit√°rios (interno e fornecedor), e a diferen√ßa de pre√ßo.</li>
                        <li><b>A√ß√£o:</b> Para cada produto, selecione <b>Aprovar</b>, <b>Negociar</b> ou <b>Rejeitar</b>.</li>
                        <li><b>Finalizar Aprova√ß√£o da PO:</b> Clique neste bot√£o apenas quando todos os itens da PO tiverem sido revisados.</li>
                        </ul>
                        <hr style="margin:16px 0;">
                        <p style="font-size:0.95rem;"><b>Dica:</b> O status de aprova√ß√£o de cada item impacta o status geral da PO.</p>
                    `;
                    break;
                default:
                    info = '<p>Esta tela faz parte do fluxo do portal. Para mais informa√ß√µes, consulte o manual ou o suporte.</p>';
            }
            showMessage('Informa√ß√µes da Tela', info, 'info');
        }

        /**
         * Retorna √† Central de Aprova√ß√£o Gerencial.
         */
        function backToRenatoApprovalCenter() {
            showScreen('renatoApprovalScreen');
            renderRenatoApprovalTables(); // Re-renderiza as tabelas de POs
        }

        /**
         * Alterna entre as abas "Aguardando Aprova√ß√£o" e "Aprovados/Rejeitados".
         * @param {string} tabType - O tipo da aba a ser ativada ('pendingApproval' ou 'approvedRejected').
         */
        function switchRenatoApprovalTab(tabType) {
            const pendingTabContent = document.getElementById('pendingApprovalTab');
            const approvedRejectedTabContent = document.getElementById('approvedRejectedTab');
            const tabButtonsContainer = document.getElementById('renatoApprovalTabButtons');

            pendingTabContent.classList.remove('active');
            approvedRejectedTabContent.classList.remove('active');

            Array.from(tabButtonsContainer.children).forEach(button => {
                button.classList.remove('active');
            });

            if (tabType === 'pendingApproval') {
                pendingTabContent.classList.add('active');
                tabButtonsContainer.children[0].classList.add('active');
            } else if (tabType === 'approvedRejected') {
                approvedRejectedTabContent.classList.add('active');
                tabButtonsContainer.children[1].classList.add('active');
            }
            renderRenatoApprovalTables(); // Re-renderiza as tabelas ap√≥s a troca de aba
        }

        /**
         * Renderiza as tabelas de aprova√ß√£o gerencial, aplicando filtros.
         */
        function renderRenatoApprovalTables() {
            const pendingTbody = document.getElementById('renatoPendingApprovalTableBody');
            const approvedRejectedTbody = document.getElementById('renatoApprovedRejectedTableBody');
            pendingTbody.innerHTML = '';
            approvedRejectedTbody.innerHTML = '';

            const supplierFilterCode = document.getElementById('renatoPoSupplierFilter').value;
            const originCountryFilter = document.getElementById('renatoPoOriginCountryFilter').value;
            const searchInput = document.getElementById('renatoPoSearch').value.toLowerCase();

            const pendingPOs = generatedPurchaseOrders.filter(po => {
                const matchesSupplier = supplierFilterCode === 'Todos' || po.supplierCode === supplierFilterCode;
                const matchesOriginCountry = originCountryFilter === 'Todos' || po.originCountry === originCountryFilter;
                const matchesSearch = searchInput === '' ||
                                      po.id.toLowerCase().includes(searchInput) ||
                                      (po.parentOrderId && po.parentOrderId.toLowerCase().includes(searchInput));
                return ['Negociado', 'Aguardando Aprova√ß√£o'].includes(po.overallApprovalStatus) && matchesSupplier && matchesOriginCountry && matchesSearch;
            });

            const approvedRejectedPOs = generatedPurchaseOrders.filter(po => {
                const matchesSupplier = supplierFilterCode === 'Todos' || po.supplierCode === supplierFilterCode;
                const matchesOriginCountry = originCountryFilter === 'Todos' || po.originCountry === originCountryFilter;
                const matchesSearch = searchInput === '' ||
                                      po.id.toLowerCase().includes(searchInput) ||
                                      (po.parentOrderId && po.parentOrderId.toLowerCase().includes(searchInput));
                return ['Aprovado', 'Rejeitado', 'Finalizado'].includes(po.overallApprovalStatus) && matchesSupplier && matchesOriginCountry && matchesSearch;
            });

            if (pendingPOs.length === 0) {
                pendingTbody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">Nenhuma PO aguardando aprova√ß√£o.</td></tr>`;
            } else {
                pendingPOs.forEach(po => {
                    const row = document.createElement('tr');
                    let statusIndicatorClass = '';
                    if (po.overallApprovalStatus === 'Aguardando Aprova√ß√£o') {
                        statusIndicatorClass = 'yellow';
                    } else if (po.overallApprovalStatus === 'Negociado') {
                        statusIndicatorClass = 'purple';
                    }
                    row.innerHTML = `
                        <td>${po.parentOrderId || 'N/A'}</td>
                        <td>${po.id}</td>
                        <td>${po.supplierCode} - ${po.supplier}</td>
                        <td>${po.originCountry}</td>
                        <td>R$ ${parseFloat(po.newSupplierPriceTotal).toFixed(2).replace('.', ',')}</td>
                        <td><span class="status-indicator ${statusIndicatorClass}"></span>${po.overallApprovalStatus}</td>
                        <td>${po.date}</td>
                        <td>
                            <button class="btn-primary" onclick="viewRenatoApprovalDetails('${po.id}')">Ver Detalhes</button>
                        </td>
                    `;
                    pendingTbody.appendChild(row);
                });
            }

            if (approvedRejectedPOs.length === 0) {
                approvedRejectedTbody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">Nenhuma PO aprovada ou rejeitada.</td></tr>`;
            } else {
                approvedRejectedPOs.forEach(po => {
                    const row = document.createElement('tr');
                    let statusIndicatorClass = '';
                    if (po.overallApprovalStatus === 'Aprovado' || po.overallApprovalStatus === 'Finalizado') {
                        statusIndicatorClass = 'green';
                    } else if (po.overallApprovalStatus === 'Rejeitado') {
                        statusIndicatorClass = 'red';
                    }
                    row.innerHTML = `
                        <td>${po.parentOrderId || 'N/A'}</td>
                        <td>${po.id}</td>
                        <td>${po.supplierCode} - ${po.supplier}</td>
                        <td>${po.originCountry}</td>
                        <td>R$ ${parseFloat(po.newSupplierPriceTotal).toFixed(2).replace('.', ',')}</td>
                        <td><span class="status-indicator ${statusIndicatorClass}"></span>${po.overallApprovalStatus}</td>
                        <td>${po.date}</td>
                        <td>${po.overallApprovalStatus}</td>
                    `;
                    approvedRejectedTbody.appendChild(row);
                });
            }
        }

        /**
         * Exibe os detalhes de uma PO para aprova√ß√£o.
         * @param {string} poId - O ID da PO a ser visualizada.
         */
        function viewRenatoApprovalDetails(poId) {
            currentViewingPO = generatedPurchaseOrders.find(po => po.id === poId);
            if (!currentViewingPO) {
                showMessage('Erro', 'Detalhes da PO n√£o encontrados para aprova√ß√£o.', 'error');
                return;
            }

            document.getElementById('renatoCurrentPoId').innerText = currentViewingPO.id;
            document.getElementById('renatoPoDetailId').innerText = currentViewingPO.id;
            document.getElementById('renatoPoDetailParentOrderId').innerText = currentViewingPO.parentOrderId || 'N/A';
            document.getElementById('renatoPoDetailSupplier').innerText = `${currentViewingPO.supplierCode} - ${currentViewingPO.supplier}`;
            document.getElementById('renatoPoDetailOriginCountry').innerText = currentViewingPO.originCountry;
            document.getElementById('renatoPoDetailNewSupplierPriceTotal').innerText = `R$ ${parseFloat(currentViewingPO.newSupplierPriceTotal).toFixed(2).replace('.', ',')}`;
            document.getElementById('renatoPoDetailCurrentInternalPriceTotal').innerText = `R$ ${parseFloat(currentViewingPO.currentInternalPriceTotal).toFixed(2).replace('.', ',')}`;
            document.getElementById('renatoPoDetailOverallApprovalStatus').innerText = currentViewingPO.overallApprovalStatus;
            document.getElementById('renatoPoDetailDate').innerText = currentViewingPO.date;
            document.getElementById('renatoPoDetailNegotiationNotes').innerText = currentViewingPO.negotiationNotes || 'Nenhuma nota de negocia√ß√£o.';

            const productsTableBody = document.getElementById('renatoPoDetailsProductsTableBody');
            productsTableBody.innerHTML = '';

            currentViewingPO.products.forEach(product => {
                const row = document.createElement('tr');
                const internalPrice = parseFloat(product.currentInternalUnitPrice);
                const supplierPrice = parseFloat(product.newSupplierUnitPrice);
                const priceDifference = (supplierPrice - internalPrice).toFixed(2);
                let priceClass = '';
                if (priceDifference > 0) {
                    priceClass = 'price-difference-positive';
                } else if (priceDifference < 0) {
                    priceClass = 'price-difference-negative';
                }

                const totalInternal = (internalPrice * product.quantity).toFixed(2);
                const totalSupplier = (supplierPrice * product.quantity).toFixed(2);

                // Determina a classe 'selected' para os bot√µes
                const approveSelected = product.approvalStatus === 'Aprovado' ? 'selected' : '';
                const negotiateSelected = product.approvalStatus === 'Negociar' ? 'selected' : '';
                const rejectSelected = product.approvalStatus === 'Rejeitar' ? 'selected' : '';

                row.innerHTML = `
                    <td>${product.code}</td>
                    <td>${product.name}</td>
                    <td>${product.quantity}</td>
                    <td>R$ ${internalPrice.toFixed(2).replace('.', ',')}</td>
                    <td>R$ ${supplierPrice.toFixed(2).replace('.', ',')}</td>
                    <td class="${priceClass}">R$ ${priceDifference.replace('.', ',')}</td>
                    <td>R$ ${totalInternal.replace('.', ',')}</td>
                    <td>R$ ${totalSupplier.replace('.', ',')}</td>
                    <td class="product-approval-status ${product.approvalStatus}">${product.approvalStatus || 'Pendente'}</td>
                    <td>
                        <div class="approval-buttons-group">
                            <button class="btn btn-approve ${approveSelected}" onclick="processApprovalDecision('${currentViewingPO.id}', '${product.code}', 'Aprovado', this)">Aprovar</button>
                            <button class="btn btn-negotiate ${negotiateSelected}" onclick="processApprovalDecision('${currentViewingPO.id}', '${product.code}', 'Negociar', this)">Negociar</button>
                            <button class="btn btn-reject ${rejectSelected}" onclick="processApprovalDecision('${currentViewingPO.id}', '${product.code}', 'Rejeitar', this)">Rejeitar</button>
                        </div>
                    </td>
                `;
                productsTableBody.appendChild(row);
            });

            showScreen('renatoPoDetailsScreen');
        }

        /**
         * Processa a decis√£o de aprova√ß√£o para um produto espec√≠fico dentro de uma PO.
         * @param {string} poId - O ID da PO.
         * @param {string} productCode - O c√≥digo do produto.
         * @param {string} decision - A decis√£o ('Aprovado', 'Negociar', 'Rejeitar').
         * @param {HTMLElement} buttonElement - O bot√£o clicado para aplicar a classe 'selected'.
         */
        function processApprovalDecision(poId, productCode, decision, buttonElement) {
            const po = generatedPurchaseOrders.find(p => p.id === poId);
            if (!po) return;

            const product = po.products.find(p => p.code === productCode);
            if (!product) return;

            product.approvalStatus = decision;

            // Remove a classe 'selected' de todos os bot√µes no mesmo grupo
            const buttonGroup = buttonElement.closest('.approval-buttons-group');
            Array.from(buttonGroup.children).forEach(btn => btn.classList.remove('selected'));

            // Adiciona a classe 'selected' ao bot√£o clicado
            buttonElement.classList.add('selected');

            // Atualiza o status geral da PO com base nos status dos produtos
            updateOverallPOStatus(po);
            synchronizeOrdersAndPOs(); // Sincroniza o estado global
            
            // Re-renderiza a linha do produto para atualizar o status visual
            viewRenatoApprovalDetails(poId); // Melhor re-renderizar a tela inteira para consist√™ncia
        }

        /**
         * Atualiza o status geral de uma PO com base no status de seus produtos.
         * @param {object} po - O objeto da PO a ser atualizado.
         */
        function updateOverallPOStatus(po) {
            const allProductsApproved = po.products.every(p => p.approvalStatus === 'Aprovado');
            const anyProductRejected = po.products.some(p => p.approvalStatus === 'Rejeitar');
            const anyProductToNegotiate = po.products.some(p => p.approvalStatus === 'Negociar');
            const anyProductPending = po.products.some(p => p.approvalStatus === 'Pendente' || !p.approvalStatus);

            if (allProductsApproved) {
                po.overallApprovalStatus = 'Aprovado';
            } else if (anyProductRejected) {
                po.overallApprovalStatus = 'Rejeitado';
            } else if (anyProductToNegotiate) {
                po.overallApprovalStatus = 'Negociado';
            } else if (anyProductPending) {
                po.overallApprovalStatus = 'Aguardando Aprova√ß√£o';
            } else {
                // Se todos os produtos foram processados (aprovados/negociados/rejeitados), mas n√£o todos aprovados,
                // e n√£o h√° mais pendentes ou para negociar, considera-se "Finalizado" (se n√£o for rejeitado)
                const allProcessed = po.products.every(p => ['Aprovado', 'Negociar', 'Rejeitar'].includes(p.approvalStatus));
                if (allProcessed && !anyProductRejected && !anyProductToNegotiate) {
                    po.overallApprovalStatus = 'Finalizado';
                } else if (allProcessed && anyProductRejected) {
                    po.overallApprovalStatus = 'Rejeitado';
                }
            }
        }

        /**
         * Finaliza a aprova√ß√£o de uma PO, atualizando seu status geral.
         * @param {string} poId - O ID da PO a ser finalizada.
         */
        function finalizePOApproval(poId) {
            const po = generatedPurchaseOrders.find(p => p.id === poId);
            if (!po) {
                showMessage('Erro', 'PO n√£o encontrada para finalizar aprova√ß√£o.', 'error');
                return;
            }

            const allProductsProcessed = po.products.every(p => ['Aprovado', 'Negociar', 'Rejeitar'].includes(p.approvalStatus));

            if (!allProductsProcessed) {
                showMessage('Aten√ß√£o', 'Todos os produtos desta PO devem ter um status de aprova√ß√£o (Aprovado, Negociar ou Rejeitar) antes de finalizar a PO.', 'warning');
                return;
            }

            // Re-calcula o status geral da PO antes de finalizar
            updateOverallPOStatus(po);

            if (po.overallApprovalStatus === 'Aprovado') {
                showMessage('Aprova√ß√£o Finalizada', `A PO ${po.id} foi APROVADA e o processo de compras pode continuar.`, 'success', () => {
                    po.overallApprovalStatus = 'Aprovado'; // Confirma o status final
                    po.lastUpdateDate = new Date().toISOString().slice(0, 10);
                    synchronizeOrdersAndPOs();
                    backToRenatoApprovalCenter();
                });
            } else if (po.overallApprovalStatus === 'Rejeitado') {
                showMessage('Aprova√ß√£o Finalizada', `A PO ${po.id} foi REJEITADA.`, 'error', () => {
                    po.overallApprovalStatus = 'Rejeitado'; // Confirma o status final
                    po.lastUpdateDate = new Date().toISOString().slice(0, 10);
                    synchronizeOrdersAndPOs();
                    backToRenatoApprovalCenter();
                });
            } else if (po.overallApprovalStatus === 'Negociado') {
                showMessage('Aprova√ß√£o Finalizada', `A PO ${po.id} foi marcada para NOVA NEGOCIA√á√ÉO. O time de Compras Internacionais ser√° notificado.`, 'warning', () => {
                    po.overallApprovalStatus = 'Negociado'; // Confirma o status final
                    po.lastUpdateDate = new Date().toISOString().slice(0, 10);
                    synchronizeOrdersAndPOs();
                    backToRenatoApprovalCenter();
                });
            } else {
                showMessage('Aten√ß√£o', `O status atual da PO (${po.overallApprovalStatus}) n√£o permite a finaliza√ß√£o. Verifique os status dos produtos.`, 'warning');
            }
        }

        /**
         * Popula o filtro de fornecedores na tela de Aprova√ß√£o Gerencial.
         */
        function populateRenatoApprovalFilters() {
            const supplierFilterSelect = document.getElementById('renatoPoSupplierFilter');
            supplierFilterSelect.innerHTML = '<option value="Todos">Todos</option>'; // Op√ß√£o padr√£o

            const uniqueSupplierCodes = new Set();
            generatedPurchaseOrders.forEach(po => {
                if (po.supplierCode) {
                    uniqueSupplierCodes.add(po.supplierCode);
                }
            });

            Array.from(uniqueSupplierCodes).sort().forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.innerText = `${code} - ${getSupplierNameFromCode(code)}`;
                supplierFilterSelect.appendChild(option);
            });

            const originCountryFilterSelect = document.getElementById('renatoPoOriginCountryFilter');
            originCountryFilterSelect.innerHTML = '<option value="Todos">Todos</option>'; // Op√ß√£o padr√£o

            const uniqueCountries = new Set();
            generatedPurchaseOrders.forEach(po => {
                if (po.originCountry) {
                    uniqueCountries.add(po.originCountry);
                }
            });

            Array.from(uniqueCountries).sort().forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.innerText = country;
                originCountryFilterSelect.appendChild(option);
            });
        }

        // Inicializa√ß√£o da p√°gina de ger√™ncia
        document.addEventListener('DOMContentLoaded', () => {
            populateRenatoApprovalFilters();
            renderRenatoApprovalTables(); // Renderiza as tabelas de POs inicialmente

            // Adiciona event listener para o bot√£o de logout
            const renatoLogoutButton = document.getElementById('renatoLogoutButton');
            if (renatoLogoutButton) {
                renatoLogoutButton.addEventListener('click', logout);
            }
        });
    </script>
</body>
</html>
